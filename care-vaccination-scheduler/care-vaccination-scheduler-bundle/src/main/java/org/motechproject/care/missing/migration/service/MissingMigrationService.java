package org.motechproject.care.missing.migration.service;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;
import javax.sql.DataSource;

import org.apache.log4j.Logger;
import org.motechproject.care.schedule.vaccinations.ChildVaccinationSchedule;
import org.motechproject.care.schedule.vaccinations.MotherVaccinationSchedule;
import org.motechproject.care.service.schedule.Anc4Service;
import org.motechproject.care.service.schedule.AncService;
import org.motechproject.care.service.schedule.BcgService;
import org.motechproject.care.service.schedule.ChildCareService;
import org.motechproject.care.service.schedule.DptBoosterService;
import org.motechproject.care.service.schedule.DptService;
import org.motechproject.care.service.schedule.Hep0Service;
import org.motechproject.care.service.schedule.HepService;
import org.motechproject.care.service.schedule.MeaslesBoosterService;
import org.motechproject.care.service.schedule.MeaslesService;
import org.motechproject.care.service.schedule.MotherCareService;
import org.motechproject.care.service.schedule.Opv0Service;
import org.motechproject.care.service.schedule.OpvBoosterService;
import org.motechproject.care.service.schedule.OpvService;
import org.motechproject.care.service.schedule.TTBoosterService;
import org.motechproject.care.service.schedule.TTService;
import org.motechproject.care.service.schedule.VitaService;
import org.motechproject.care.service.util.CommcareTask;
import org.motechproject.casexml.gateway.CommcareCaseGateway;
import org.motechproject.mcts.care.common.mds.dimension.ChildCase;
import org.motechproject.mcts.care.common.mds.dimension.MotherCase;
import org.motechproject.mcts.care.common.mds.domain.CareCaseTask;
import org.motechproject.mcts.care.common.mds.repository.MdsRepository;
import org.motechproject.scheduletracking.domain.Enrollment;
import org.motechproject.scheduletracking.service.EnrollmentAlertServiceToExport;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

@Service
public class MissingMigrationService {
	 
	private static final Logger LOGGER = Logger.getLogger(MissingMigrationService.class);
	
	private static final String COMMCARE_HQ_URL = "https://india.commcarehq.org/a/care-bihar/receiver/";
	
	private static final String COMMCARE_USERNAME = "motech_care@thoughtworks.com";
	
	private static final String COMMCARE_PASSWORD = "parkingProcess0z.24";
    
    @Resource(name = "careDataSource")
    private DataSource careDataSource;
    
    @Autowired
    MdsRepository dbRepository; 
    
    @Autowired
    TTService ttService;
    
    @Autowired
    TTBoosterService ttBoosterService;
    
    @Autowired
    AncService ancService;
    
    @Autowired
    Anc4Service anc4Service;
    
    @Autowired 
    MotherCareService motherCareService;
    
    @Autowired 
    MeaslesService measlesService;
    
    @Autowired
    MeaslesBoosterService measlesBoosterService;
    
    @Autowired
    BcgService bcgService;
    
    @Autowired
    VitaService vitaService;
    
    @Autowired
    Hep0Service hep0Service;
    
    @Autowired
    HepService hepService;
    
    @Autowired
    DptService dptService;
    
    @Autowired
    DptBoosterService dptBoosterService;
    
    @Autowired
    Opv0Service opv0Service;
    
    @Autowired
    OpvService opvService;
    
    @Autowired
    OpvBoosterService opvBoosterService;
    
    @Autowired
    ChildCareService childCareService;
    
    @Autowired
    private EnrollmentAlertServiceToExport enrollmentAlertServiceToExportOSGi;
    
    @Autowired
    private CommcareCaseGateway commcareCaseGateway;
    
    
    private int vaccinationCountMother;
    
    private int vaccinationCountChild;
    
    List<String> schedulesLstAllMot = new ArrayList<String>();
    List<String> schedulesLstAllChild = new ArrayList<String>();
    List<Integer> AllMissingTasks = new ArrayList<Integer>();
    
    public MissingMigrationService() {
    	
    	Integer[] missingTasks = {327680,327682,327692,327702,327696,327705,327717,327718,327713,327715,327720,327723,327732,327734,327730,262201,262202,327758,327764,327767,327766,327760,327762,327773,327775,327769,327771,327781,327776,327778,327791,327796,327798,327793,327795,327805,327806,327801,327803,327808,327811,336015,327831,327837,327833,327840,327852,327855,327854,327851,327850,327861,327863,327857,327868,327865,327866,327877,327878,327874,327885,327880,327883,327882,327893,327895,327900,327897,327898,327909,327906,327912,327914,327924,327927,327926,327921,327922,327935,327928,327931,327941,327943,327936,336131,327938,336141,327948,327951,327945,327946,336148,327956,336151,336150,327958,327953,327952,327955,336157,336156,327966,327961,327963,336154,327962,327972,327975,327969,327968,327980,327982,327977,327976,327979,327988,327990,327985,327987,327996,327999,327998,327992,327994,328005,328001,328003,328013,328011,49487,328010,49488,49490,49524,49525,49527,328077,328076,328079,328072,328074,328085,328086,328081,328083,328092,328095,328094,328088,328090,49569,49570,49572,328110,328118,328112,328115,328114,328133,328132,328139,328148,328151,328150,328144,328146,328159,328155,328165,328167,328162,328173,328168,328170,328177,328189,328191,328184,328186,328192,328195,328194,328205,328211,328220,328223,328216,328232,328234,328244,328247,328246,328240,328253,328256,328270,49740,328264,49741,49743,328285,328283,328292,49761,49762,49764,328300,328302,328299,328308,328310,328307,328317,328318,328312,328335,328340,328343,328342,328350,328346,328355,328364,328367,328360,328375,328374,328381,328378,328391,328390,328384,328399,328393,328394,328401,328402,328409,328408,328420,328431,328430,328424,328437,49913,49914,49916,328443,328454,328448,328451,328463,328462,328456,328459,328469,328476,328473,328485,328493,328490,49968,49969,328502,49971,328497,328498,328509,328508,328511,328505,328506,328513,328515,328527,328521,328533,328528,328531,328530,328536,328539,328546,328559,328553,328555,328565,328560,328573,328575,328569,328568,328581,328582,328576,328579,328588,328591,328585,328584,328587,328597,328596,328599,328605,328607,328603,328615,328645,328647,328643,328648,328651,328669,328676,328678,328672,328674,336880,336882,328700,328702,336889,328708,328710,328704,328706,328712,328725,328724,328732,328734,328740,328743,328742,328736,328738,328749,328750,328745,328747,328752,328767,328760,328762,328772,328775,328770,328780,328790,328796,328793,328795,328807,328801,328802,328814,328809,328810,328828,328827,328837,328839,328834,328840,328853,328849,328867,328878,328880,328891,328901,328911,328919,328913,328933,328931,328950,328944,328947,328959,328958,328972,328969,328971,328970,328981,328980,328978,328985,328984,328986,328993,329005,329007,329001,329003,329015,329014,329008,329010,329021,329023,329016,329019,329018,329028,329030,329025,329027,329037,329036,329039,329033,329032,329034,329045,329046,329041,329043,329042,329048,329060,329063,329062,329058,329069,329071,329065,329067,329076,329078,329072,329074,329085,329087,329081,329080,329083,329092,329094,329089,329090,329101,329103,345481,329096,345480,329099,329098,329108,329110,329105,329107,329117,329116,329119,329113,329112,329114,329124,329127,329126,329123,329122,329134,329129,329141,329136,329139,329138,329148,329151,329150,329146,329156,329158,329153,329165,329167,329161,329160,329163,329172,329175,329169,329170,329180,329182,329177,329179,329189,329188,329185,329184,329198,329193,329192,329194,329207,329212,329214,329209,329208,329211,329221,329223,329216,329218,329229,329224,329227,329226,329233,329232,329235,329247,329241,329243,329242,329252,329249,329260,329263,329256,329258,329269,329271,329264,329266,329276,329272,329285,329287,329280,329282,329288,329290,329301,329303,329310,329304,329307,329306,329316,329326,329320,329323,329322,329333,329332,329331,329341,329342,329337,329336,329339,329338,329349,329347,329346,329359,329358,329355,329354,329365,329364,329367,329366,329361,329373,329372,329375,329368,329371,329380,329377,329391,329397,329396,329392,329395,329405,329404,329406,329403,329402,329412,329414,329411,329410,329417,329416,329419,329418,329425,329424,329427,329426,345820,329438,329433,329432,345816,329445,329447,329446,329440,329455,329454,345833,329450,329463,345847,329462,329457,329465,329466,329478,329473,329474,329486,329480,329483,329493,329492,329489,329500,329503,329502,329496,329498,329509,329508,329505,329506,329516,329519,329513,329512,329515,329514,329524,329520,329522,329533,329535,329531,329536,329538,329558,329565,345950,329560,329563,345947,329562,345957,329572,345959,329574,345958,329568,329570,329580,329582,329577,329589,329591,329585,345969,329584,329587,329596,329598,329607,329602,329612,329614,329609,329611,329628,329631,329630,329627,329626,329637,329639,329633,329635,329644,329646,329640,329642,329653,329655,329654,329649,329648,329651,329660,329663,329662,329657,329658,329669,329671,329664,329667,329666,329676,329678,329673,329672,329675,329685,329684,329687,329681,329680,329682,329693,329694,329689,346072,329691,346074,329690,329701,329703,329696,329699,329709,329711,329710,329704,329706,329716,329718,329713,329714,329725,329724,329726,329735,329734,329729,329728,329731,329742,329736,329739,329738,329749,329748,329751,329745,329744,329746,329757,329758,329753,329755,329765,329764,329767,329766,329760,329763,329772,329774,329770,329781,329783,329782,329788,329791,329790,329785,329787,329797,329793,329794,329805,329804,346191,329807,329800,346187,329802,329839,329833,329845,329846,329840,329848,329893,329892,329895,329889,329888,329890,329940,329943,329942,329938,329948,329945,329947,329957,329956,329959,329952,329954,329982,329978,329991,329985,329984,329987,329998,329995,330004,330007,330000,330012,330014,330009,330011,330029,330030,330025,330027,330037,330039,330038,330032,330044,330041,330042,330055,330060,330062,330057,330056,330059,330071,330070,330064,330067,330066,330077,330076,330072,330075,330084,330087,330086,330080,330082,330093,330095,330089,330091,330101,330096,330098,330109,330111,330104,330107,330106,330116,330118,330113,330115,330133,330132,330135,330128,330130,330141,330140,330143,330139,330149,330148,330150,330144,330146,330157,330159,330153,330152,330155,330165,330164,330160,330163,330173,330175,330169,330168,330171,330180,330182,330177,330179,330189,330188,330191,330184,330186,330197,330198,330193,330195,330205,330207,330200,330203,330212,330214,330208,330210,330217,330216,330219,330228,330231,330230,330226,330233,330235,330245,330240,330243,330242,330252,330254,330250,330256,330259,330276,330279,330273,330272,330275,330285,330284,330287,330282,330292,330295,330289,330291,330290,330303,330302,330297,330296,330298,330309,92739,330311,338502,330310,330305,92740,330304,92743,92742,330317,330319,330314,330324,330327,330321,338515,330322,330333,330334,338523,330331,330342,330336,330339,330338,330349,330350,330345,330346,92784,92787,330358,330353,330352,330355,92791,330354,92790,92793,330367,330361,330363,330362,330372,338567,330374,330369,330371,92807,92809,330383,92811,330382,330377,330376,92812,330379,92814,338580,330388,330391,330385,330384,330396,330398,92829,330393,92831,330395,330394,92833,330404,92835,330407,92837,330401,330400,330403,330412,338607,338606,330411,330421,330423,330417,338611,330419,330428,330430,330426,330437,330436,330439,330433,330445,330447,330440,338635,330443,330455,330454,330448,330461,330463,330456,330459,330458,338650,330469,330468,330470,330465,330464,330476,330478,330474,330485,330487,330486,330480,330483,330482,330495,330494,330489,330491,330501,330497,330499,330508,330510,330506,330516,330519,330513,330512,330515,338706,330526,330520,92959,330523,92961,338724,92963,330535,338721,92964,330528,92966,330540,330543,346926,338731,346933,330549,330548,330551,346934,330545,346928,330556,346940,330559,346943,330558,330555,346938,330564,330567,330566,330560,330562,330575,330569,330571,330570,330583,330582,330576,330579,330578,330589,330590,330584,330587,330596,330599,330598,330593,330594,330605,330607,330600,330603,330615,330614,330609,330610,330621,338812,330616,330619,330618,330629,347013,330630,347009,330624,330627,330626,330637,330635,330634,330645,93074,93077,330643,93079,330653,93080,338847,330654,93082,330649,330648,330650,93089,330661,330660,93091,330663,330662,93093,330657,338850,93094,330658,330669,93096,330665,330667,330676,330679,330673,330672,330674,330684,330686,338872,330680,330693,330689,93124,330688,93126,330690,93129,330701,93128,93131,330703,330697,330696,330699,330709,330708,330711,330705,330704,330707,330717,330716,330718,330715,330725,330724,330723,330733,330732,338927,330735,330734,330729,330730,93166,93168,330743,93171,330742,93170,93173,330739,338930,330738,330749,338942,330745,330747,330757,330756,330759,330758,330752,330755,338957,330765,330764,330767,330773,330772,330769,93204,330771,93206,93209,93208,330780,93211,330782,330777,330776,330789,330788,347172,330791,338982,93218,330790,330785,93220,330784,338979,93223,93222,93225,330797,330799,330798,347182,93228,330792,347176,347179,347178,330805,93232,330804,330807,93236,330803,93238,330802,330812,339007,330815,93242,330814,330808,330811,330810,330820,339014,330816,330819,330818,330829,330830,330825,330824,330827,339018,330826,330837,330836,339031,330838,339024,330832,339027,330835,330834,330845,339036,339039,330847,339032,330842,339045,330852,330849,330851,330850,330861,339054,330857,330856,330859,330858,339061,330869,93296,93298,330865,93301,93300,93303,330866,330876,339071,330879,330872,330875,330885,339073,339074,330882,339084,330894,339081,330891,330890,330901,330900,330903,339089,330897,330896,339091,339090,339100,330908,330911,339102,339096,330904,330906,330917,339108,330919,330918,339105,330913,339104,330912,339117,330925,330924,330927,330926,330923,330932,330935,339120,330930,330941,339134,330942,339129,330936,339140,339143,330950,330945,330947,330957,330956,330953,330952,339146,330965,93392,330964,93394,330966,93397,93396,330960,93399,330962,330973,330972,339166,330969,330968,330971,330983,339174,330982,330976,330979,330978,330989,339180,339183,330991,330990,330984,330986,339189,330998,331007,331006,331001,331000,331003,331002,331013,331015,331014,331009,331021,331023,339209,331019,339210,331018,331029,331028,331030,331024,331026,331037,331036,339230,331038,339225,331033,339227,331034,331045,339239,331047,339233,331040,331053,331054,331049,331061,339248,331059,331069,331065,339259,331067,339258,331076,331079,331075,331085,331084,331087,331086,339272,331080,331082,331093,339287,331094,331089,331090,331103,331096,331099,331109,331111,331110,339297,331105,331104,339299,331107,331117,331119,331118,331113,331115,331124,331127,339318,331126,339313,331120,331133,331132,331134,339323,331140,93570,331137,339328,93574,331149,331148,331151,93578,331145,93580,331144,331147,93585,331156,331159,331158,331153,339344,331152,331165,331164,339352,331160,331173,331172,331175,331169,93606,93608,331180,93611,331182,93612,93614,331178,331188,331191,331190,331185,331184,331186,93622,331197,93625,331196,331199,93629,331195,93630,331205,93633,331204,93635,331206,93637,331201,331200,93639,93640,93642,331211,331210,331223,331222,331217,331216,331219,331218,331229,331230,331225,331224,331244,331240,331253,331255,331254,331249,331251,331261,331263,331256,331258,331269,331268,331271,331267,331276,331273,331285,331287,331286,331281,331282,93721,331293,331292,93723,331295,331289,93727,331300,331303,93730,331302,331297,331298,93737,331308,93739,331311,331310,331305,331307,331317,331316,93747,331312,331315,93750,93755,93757,331320,93761,331335,331334,331329,93764,331328,331331,331341,331343,331342,331336,331339,331349,331348,331347,331356,331353,331352,331355,331354,331364,331361,331362,331372,331375,331369,331371,331370,331381,331380,331382,331379,331378,331388,331391,331390,331385,331386,331396,331399,93826,331393,93828,331392,93831,331394,93830,93833,331404,93835,331406,93837,331401,93839,331402,93840,331412,331415,93842,331414,331408,331411,331410,331420,331422,331419,331418,331429,331428,331430,331427,331438,331433,93868,93870,331434,93873,93872,93875,331447,331446,331441,331440,331442,331453,331452,331455,331454,331448,331450,331460,331463,331462,331458,331469,331471,331470,331465,331467,331477,331479,331478,331472,331484,331486,331481,331483,331493,331495,331494,331488,331501,331500,331503,331502,331497,331498,331511,331510,331507,331516,331518,331512,331514,93953,331525,331524,93955,331527,331526,93957,331520,93958,331522,93960,331532,331535,331534,331530,331541,331542,331537,331536,331548,331550,331545,331544,93983,93985,93987,331558,93988,331555,331554,93990,347948,331564,331566,331560,331562,331572,331575,331574,347952,331568,331581,331577,331579,331578,331591,331590,331585,331584,331587,331596,331598,331593,331594,331605,331604,331601,331613,331615,331614,331609,331610,331620,94053,331616,331619,94055,94057,331628,331630,94058,331625,94060,331627,331638,331633,348017,331635,348018,331645,331647,348030,331641,331640,348027,331642,348026,331652,348036,331648,348032,331650,331661,331660,331663,331662,331656,331658,331668,331671,331664,331667,331677,331679,331673,331675,331687,331681,331683,331682,331694,331689,331690,331700,331703,331702,331708,331710,331705,331706,331716,331719,331718,331713,331714,331724,331722,331733,331732,331735,331728,94167,331730,94169,94171,331742,94173,331736,331739,331749,94177,331745,331747,331757,331756,331758,331752,331765,331766,331761,331762,331773,331769,331771,94210,331782,331777,94212,94215,94214,331778,94217,331789,331788,331791,331787,331797,331799,331792,331794,331805,331807,94237,94239,331803,331802,94241,331812,331814,94242,331809,94244,331811,331820,331817,331828,331831,331824,331827,94262,94264,331836,94267,331839,94266,94269,331845,331847,331841,331843,331853,331855,331849,331851,331863,331862,94290,94292,331856,94295,331859,94294,331869,94297,331871,331864,331867,331866,331877,331879,331872,331875,331886,331880,331882,331892,331895,331889,331891,331900,331903,331902,331899,331898,331911,331905,331917,331918,331914,331925,331920,94361,331933,94360,331932,331935,331929,331940,331942,331936,331939,331951,331944,331946,331956,331958,331953,331955,331965,331964,331967,331960,331962,331973,331975,331969,331971,331981,331983,331977,331979,331978,331989,331991,331985,331987,331996,331998,331992,331994,348388,332006,348385,332001,332000,332003,332012,332015,332014,332009,332021,332020,348407,332017,348400,332018,94454,332029,332028,94456,94459,94458,332024,332026,94462,332037,94465,332036,94467,94469,332032,94470,94472,332047,94474,332046,332041,94476,332040,94479,332043,94478,332042,94481,94487,332062,94497,332069,332064,332067,332066,332077,332078,332072,332075,332084,332087,332086,332081,332080,348476,332092,332095,348478,332088,332091,332090,332101,332103,332096,332098,332108,332110,332105,332106,332118,332112,332115,332114,332124,332126,332134,332129,332128,332131,94566,332141,94570,332142,332137,94575,332139,94574,332151,94578,332144,332159,332158,332153,332154,332165,332167,332166,94597,332160,94599,94601,332173,94602,94604,332171,332170,332181,332183,332176,332178,332188,332184,332187,332197,332196,94635,332207,332206,332203,332202,94638,332215,94642,332214,94645,332209,332208,332211,332210,332221,94648,332220,332217,332216,332229,332231,332230,332225,332224,332227,332226,332239,332233,332232,332235,94670,332234,94672,332244,94675,332247,94674,94677,332241,332240,94679,332242,94681,332253,332252,94683,332255,94684,332248,332251,94686,332262,332256,332258,94697,332269,94699,332271,94701,332264,332267,94702,332266,94704,332276,332278,332273,332275,332285,332286,332281,332283,332292,332295,332294,332288,332291,332290,332301,332300,332303,332297,332299,332309,332308,332311,332310,332304,332306,332317,332316,332319,332318,332313,332312,332327,332326,332323,332322,332335,332334,332329,332328,332331,332330,94769,332341,332340,94771,94770,94773,332337,332336,94774,332349,94776,332351,332350,94781,332345,332344,94783,332347,332346,94785,332357,332356,94786,332353,94788,332354,94790,332365,332364,94792,332367,94795,332366,94794,94797,332360,94799,332363,332362,94801,332373,332372,94803,94804,332371,94806,332370,332381,94808,332380,94810,332382,94813,332377,94812,332376,94815,94817,94818,94821,332385,332384,332387,332397,94824,332399,332398,94829,94831,94833,332404,94834,332401,94836,332402,94841,332413,332412,94843,332415,94845,332409,332408,94846,332410,94848,332420,94851,332423,94850,332422,94853,94855,332419,332418,94857,332429,332428,94859,94858,332430,332425,94860,94862,332437,94864,94867,332439,94866,332438,94869,332433,332432,78487,332435,78486,78489,94872,332444,332447,94874,332446,332441,94876,94879,94878,332442,94881,332453,348836,94883,332455,94885,332448,94887,332451,332450,94888,332460,94890,332462,332457,94892,332456,332459,94894,94897,332469,94896,94899,332471,94901,94903,332467,94905,94906,94908,332472,94910,332474,94912,94915,94914,94917,94916,94919,94921,332493,94920,332492,94923,332495,94924,332488,94926,332490,94928,332503,94930,94933,94932,94935,332509,94937,332508,332511,94939,332505,94941,94942,94944,332519,332518,94946,94948,94951,94950,94953,94959,94964,94966,94969,94968,332540,94971,332543,94973,332537,94975,94977,94979,94980,332544,94983,94982,332546,94985,94987,94988,94997,94999,94998,95001,95003,95002,95004,332581,95011,332583,95013,332577,332576,95015,332578,332589,95016,332591,95018,332585,95023,332586,95024,332596,95026,95028,95031,332595,95030,95033,332605,332604,332607,332601,95039,95038,332602,95040,95043,95042,95045,95044,332608,332610,95050,95052,95055,95054,95057,332631,95058,95060,95063,332637,95064,95066,332638,332633,95068,95070,95073,95072,95075,332640,95083,95085,95087,95088,95090,95092,95094,95097,95096,95099,95101,95103,95102,95105,95106,95108,95111,95110,95112,95115,95114,95119,95118,95121,95120,95125,95124,95128,95130,95133,95132,95135,349093,349095,95146,95148,95151,95150,95153,95158,95160,95163,95162,95165,95167,95169,95171,95172,95174,95177,95176,95178,95181,95180,95183,95182,95185,95187,95186,95189,95191,95190,349149,95192,95195,95194,95196,95199,349147,95198,95201,95200,349156,95203,95205,349153,95204,95207,349154,95209,95208,95210,349161,349160,95215,95217,95219,95220,95222,95225,95224,95226,95229,95228,95231,95233,95235,95237,95238,95240,95243,95242,95244,95247,95246,95249,349204,95251,349206,95253,95255,95256,349212,95258,95260,95262,349210,95265,95264,332836,95267,332839,332833,349217,332835,332845,332844,332846,332840,332842,332852,332854,332849,332861,332856,332859,332858,332884,332886,332893,332895,332889,332888,332891,332900,332903,332902,332897,332898,332908,332911,332910,332917,332919,332918,332913,332925,332924,332927,332920,332933,332935,332929,332928,332931,332943,332937,332936,332939,332949,332950,332945,332944,332957,332956,332952,332965,332966,332961,332963,332974,332968,332981,332976,332979,332978,316605,316603,332997,349381,332996,332999,349383,349382,332992,332994,333005,349388,333007,333001,349385,333003,349386,333010,333020,333022,333029,333031,333025,333026,333036,333038,333033,333035,349428,349431,349430,349426,349433,349447,349452,349454,349449,349451,349460,349462,349457,349456,349459,349458,349468,349464,333100,333103,333102,333098,333105,333116,333119,349503,333118,349497,333115,349499,333124,349510,333121,349505,333123,333133,333135,333128,333140,333137,333138,333148,333151,333150,333144,333147,333146,333157,333159,333153,333164,333161,333162,333183,349575,333184,333197,349581,349580,333199,349583,333198,349577,349576,333204,333207,333206,333201,333202,333213,333212,333215,349599,349593,333208,333211,333210,333220,349604,333222,349606,333216,333219,333229,333228,333231,333225,333224,349608,333226,333246,325060,333253,333255,325056,325057,333248,333251,333250,349645,349644,349647,333262,349641,349640,333258,349642,333268,333270,333264,333266,333272,333285,333287,333283,325100,333293,333294,325096,333288,325098,333290,333301,333300,333303,333299,333309,333308,333311,333304,333306,333316,333318,333313,333312,333315,333327,333332,333334,333329,333328,333331,325149,333340,333343,333342,325145,325146,333338,333349,333351,333345,333357,333359,333358,333353,333354,333364,333360,333363,333373,333372,333375,333368,333370,333381,333380,333383,333379,333384,333386,325204,333397,333396,333399,333398,333393,325201,333392,333394,333405,333404,325215,333400,333403,333412,333414,333408,333422,333417,333416,333419,333429,333431,333424,333427,333426,333436,333438,333433,333435,333445,333447,333449,333450,333461,333462,333457,333459,333458,333465,333464,333477,333479,333475,333485,333484,333486,333480,333482,333493,333494,325303,333489,333488,333491,333500,333503,333502,333499,333498,325316,333509,325317,333511,325319,333505,333516,333513,333514,333525,333524,333527,333523,333522,333528,333530,325356,325357,325354,325362,325375,325409,325419,325438,325439,325442,325455,325465,325509,325511,325507,325518,325512,325514,325526,325520,325522,325523,325533,325535,325531,325540,325541,325542,325536,325538,325544,325545,325547,325556,325558,325564,325560,325561,325590,325597,325598,325594,325600,325615,325620,325623,325617,325619,325636,325637,325632,325634,325644,325646,325647,325642,325651,325661,325663,325659,325671,325664,325666,325676,325678,325679,325674,325685,325680,325692,325688,325689,325700,325701,325702,325708,325711,325705,325706,325716,325718,325713,325715,333917,325735,325740,325741,325743,325738,325750,325757,325758,325754,325765,325766,325760,325773,325768,325770,325771,325781,325783,325776,325779,325789,325791,325785,325787,325796,325797,325798,325799,325792,325795,325804,325805,325803,325814,325809,325811,325821,325822,325816,325819,325824,325863,325868,325869,325871,325865,325885,325886,325880,325883,325888,325932,325935,325930,325937,325939,325956,325958,325959,325954,325961,325973,325974,325975,325981,325982,325983,325977,325978,325986,325997,325998,325999,326004,326001,326002,326012,326014,326015,326010,326017,326030,326037,326032,326034,326035,326069,326070,326065,326066,326067,326079,326072,326085,326086,326083,326095,326088,326100,326101,326102,326098,326109,326110,326111,326105,326106,326116,326119,326114,326115,326120,326132,326134,326135,326130,326141,326143,326139,326148,326150,326145,326147,326164,326165,326166,326168,326169,326171,326189,326191,326196,326193,326194,326204,326206,326207,326202,326209,326231,326236,326238,326232,326233,326235,326262,326268,326270,326265,326267,326292,326294,326301,326303,326296,326297,326299,326308,326305,326306,326327,326332,326333,326334,326328,326329,326331,326340,326341,326342,326343,326336,326338,326348,326346,326347,326356,326358,326352,326360,326361,326363,326375,326380,326382,326377,326379,326396,326397,326398,326400,326401,326403,326414,326415,326408,326410,326411,326421,326418,326428,326429,326425,326427,326438,326439,326432,326433,326434,326444,326445,326446,326442,326452,326454,326450,326461,326463,326456,326458,326468,326469,326471,146247,326465,146245,326476,326479,326484,326481,326482,326493,326494,326489,326490,326491,326497,326511,326517,326518,326512,326514,326521,326533,326534,326529,326530,326531,326536,326551,326556,326557,326559,326553,326575,326582,326583,326576,326588,326589,326591,326587,326592,326595,326621,326622,326623,326629,326626,326627,326636,326637,326639,326635,326646,326640,326642,326653,326655,326648,326650,326661,326662,326657,326659,326669,326671,326664,326667,326672,326674,326685,326686,326687,326681,326683,326694,326690,326691,326696,326698,326710,326717,326718,326712,326714,326715,326724,326726,326721,326723,326788,326789,326791,326784,326786,326796,326798,326804,326801,326802,326814,326811,326820,326823,326816,326817,326819,326828,326825,326826,326845,326846,326841,326843,326848,326861,326863,326859,326870,326864,326866,326877,326872,326874,326875,326883,326894,326889,326898,326909,326905,326918,326913,326915,326925,326920,326940,326941,326942,326948,326944,326945,326956,326957,326959,326952,326953,326954,146763,326990,146761,146766,146765,326987,146768,326998,326994,327006,327052,327054,327060,327062,327056,327071,327066,327076,327085,327081,327090,327110,327111,327116,327117,327118,327119,327112,327115,327124,327125,327126,327133,327134,327129,327131,327136,327139,327165,327166,327161,327163,327168,327205,327207,327212,327209,327210,327222,327216,327230,327238,327232,327234,327235,327245,327247,327242,327248,327250,327268,327270,327271,327265,327278,327273,327275,327280,327281,327283,327292,327293,327294,327296,327297,327299,327308,327310,327311,327306,327313,327326,327327,327334,327329,327341,327336,327338,327339,327349,327351,327345,327347,327353,327372,327373,327374,327380,327376,327377,327388,327389,327391,327384,327386,327400,327402,327421,327422,327423,327429,327431,327425,327427,327436,327438,327445,327440,327441,327443,327452,327455,327449,327451,327461,327463,327457,327464,327466,327477,327479,327474,327484,327480,327502,327508,327511,327506,327516,327517,327519,327512,327513,327524,327525,327527,327521,327523,327528,327530,327541,327542,327536,327537,327538,327544,327556,327559,327553,327555,327561,327562,327563,327573,327575,327571,327576,327578,327597,327598,327592,327595,327604,327607,327600,327602,327613,327615,327608,327610,327620,327617,327618,327629,327624,327639,327634,327635,327644,327645,327646,327652,327649,327650,327661,327663,327659,327664,327666,327677,327679,327675};
    	AllMissingTasks = Arrays.asList(missingTasks);
    	schedulesLstAllMot =  new ArrayList<String>();
    	schedulesLstAllMot.add(MotherVaccinationSchedule.TT.getName());
    	schedulesLstAllMot.add(MotherVaccinationSchedule.TTBooster.getName());
    	schedulesLstAllMot.add(MotherVaccinationSchedule.Anc.getName());
    	schedulesLstAllMot.add(MotherVaccinationSchedule.Anc4.getName());
    	schedulesLstAllMot.add("Mother Care");
    	schedulesLstAllChild = new ArrayList<String>();
    	schedulesLstAllChild.add(ChildVaccinationSchedule.Bcg.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.DPT.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.DPTBooster.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.Hepatitis.getName());
    	schedulesLstAllChild.add("Child Care");
    	schedulesLstAllChild.add(ChildVaccinationSchedule.Hepatitis0.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.Measles.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.MeaslesBooster.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.OPV.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.OPV0.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.OPVBooster.getName());
    	schedulesLstAllChild.add(ChildVaccinationSchedule.Vita.getName());
    	
		
	}
    
    
    public void enrollAllMissingMotherVaccines(){
    	 vaccinationCountMother =1;
    	 List<Map<String, Object>> mothers = getMothers();
         
    	 LOGGER.info("Total Number of mothers fetched "+mothers.size());
         
    	 int motherCount = 1;
         
    	 for (Map<String, Object> caseMap : mothers) {
        	 
        	 LOGGER.info("Started Processing **** Mother "+motherCount+" :" +caseMap.get("caseId"));
        	 try {
              MotherCase mother = dbRepository.get(MotherCase.class, "caseId", caseMap.get("caseId"));
              LOGGER.info("Processing case name"+ mother.getCaseName());
              enrollUpdateMotherVaccine(mother,caseMap.get("schedules").toString());
        	 } catch (Exception e) {
        		 LOGGER.info("Failed Processing mother"+e.getMessage());
        	 }
        	  
        	 LOGGER.info("Processed mother vaccinations.....");
        	 motherCount++;
 		}
    	 LOGGER.info("Total Vaccinations processed for mother "+vaccinationCountMother);
    	
    }
    
    
    
    public void enrollAllMissingChildVaccines() {
    	 List<Map<String, Object>> childs = getChilds();
         LOGGER.info("Total Number of childs fetched "+childs.size());
        
         int childCount = 1;
         vaccinationCountChild=1;
        
         
         for (Map<String, Object> caseMap : childs) {
        	 
        	 LOGGER.info("Started Processing **** Child "+childCount+" :" +caseMap.get("caseId"));
        	 try {
        	 ChildCase child = dbRepository.get(ChildCase.class, "caseId", caseMap.get("caseId"));
        	 LOGGER.info("Processing case name"+ child.getCaseName());
        	 enrollUpdateChildVaccine(child,caseMap.get("schedules").toString());
        	 }  catch (Exception e) {
        		 LOGGER.info("Failed Processing mother"+e.getMessage());
        	 }
        	 LOGGER.info("Processed child vaccinations.......");
        	 childCount++;

         }
         LOGGER.info("Total Vaccinations processed for child "+vaccinationCountChild);
    }
    
    
    private void enrollUpdateMotherVaccine(MotherCase mother, String schedules) {
    	LOGGER.info("Already scheduled vaccines"+ schedules);
    	List<String> schedulesLst =Arrays.asList(schedules.split(","));
    	List<String> toRun = new ArrayList<String>(schedulesLstAllMot);
    	toRun.removeAll(schedulesLst);
    	
    	for (String schedule : toRun) {
    		if(schedule.equals(MotherVaccinationSchedule.TT.getName())) {
    			LOGGER.info("Enrolling mother with case id in "+ MotherVaccinationSchedule.TT);
    			ttService.process(mother);
    			vaccinationCountMother++;
    		}
    		if(schedule.equals(MotherVaccinationSchedule.TTBooster.getName())) {
    			LOGGER.info("Enrolling mother with case id in "+ MotherVaccinationSchedule.TTBooster);
    			ttBoosterService.process(mother);
    			vaccinationCountMother++;
    		}
    		if(schedule.equals(MotherVaccinationSchedule.Anc.getName())) {
    			LOGGER.info("Enrolling mother with case id in "+ MotherVaccinationSchedule.Anc);
    			ancService.process(mother);
    			vaccinationCountMother++;
    		}
    		if(schedule.equals(MotherVaccinationSchedule.Anc4.getName())) {
    			LOGGER.info("Enrolling mother with case id in "+ MotherVaccinationSchedule.Anc4);
    			anc4Service.process(mother);
    			vaccinationCountMother++;
    		}
    		if(schedule.equals("Mother Care")) {
    			LOGGER.info("Enrolling mother with case id in Mother Care");
    			motherCareService.process(mother);
    			vaccinationCountMother++;
    		}
    	
		}	
    }
 
    
    private void enrollUpdateChildVaccine(ChildCase child, String schedules) {
    	LOGGER.info("Already scheduled vaccines"+ schedules);
    	List<String> schedulesLst =Arrays.asList(schedules.split(","));
    	
    	List<String> toRun = new ArrayList<String>(schedulesLstAllChild);
    	toRun.removeAll(schedulesLst);
    	
    	for (String schedule : toRun) {
    		if(schedule.equals(ChildVaccinationSchedule.Measles.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.Measles);
    			measlesService.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals(ChildVaccinationSchedule.MeaslesBooster.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.MeaslesBooster);
    			measlesBoosterService.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals(ChildVaccinationSchedule.Bcg.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.Bcg);
    			bcgService.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals(ChildVaccinationSchedule.Vita.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.Vita);
    			vitaService.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals(ChildVaccinationSchedule.Hepatitis0.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.Hepatitis0);
    			hep0Service.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals(ChildVaccinationSchedule.Hepatitis.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.Hepatitis);
    			hepService.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals(ChildVaccinationSchedule.DPT.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.DPT);
    			dptService.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals(ChildVaccinationSchedule.DPTBooster.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.DPTBooster);
    			dptBoosterService.process(child);
    		}
    		if(schedule.equals(ChildVaccinationSchedule.OPV0.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.OPV0);
    			opv0Service.process(child);
    		}
    		if(schedule.equals(ChildVaccinationSchedule.OPV.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.OPV);
    			opvService.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals(ChildVaccinationSchedule.OPVBooster.getName())) {
    			LOGGER.info("Enrolling child with case id in "+ ChildVaccinationSchedule.OPVBooster);
    			opvBoosterService.process(child);
    			vaccinationCountChild++;
    		}
    		if(schedule.equals("Child Care")) {
    			LOGGER.info("Enrolling child with case id in Child Care");
    			childCareService.process(child);
    			vaccinationCountChild++;
    		}
		}
    }
 
	
    private List<Map<String, Object>> getMothers(){
    	JdbcTemplate jdbcTemplate = new JdbcTemplate(careDataSource);	
   		return jdbcTemplate.queryForList("select caseId, group_concat( distinct e.scheduleName) as schedules  from CARE_MCTS_COMMON_ENTITIES_MOTHERCASE m inner join SCHEDULE_TRACKING_MODULES_ENROLLMENT e on m.caseId=e.externalId where m.edd >= '2015-4-10' and actualDeliveryDate is null group by m.caseId"); 
    }
    
    
    private List<Map<String, Object>> getChilds(){
    	JdbcTemplate jdbcTemplate = new JdbcTemplate(careDataSource);
   		return jdbcTemplate.queryForList("select caseId, group_concat( distinct e.scheduleName) as schedules  from CARE_MCTS_COMMON_ENTITIES_CHILDCASE cc inner join SCHEDULE_TRACKING_MODULES_ENROLLMENT e on cc.caseId=e.externalId where cc.dob >= '2013-04-08' group by cc.caseId"); 
    }
    
  
    
	
    public void scheduleEnrollment() {
    	
    	List<Enrollment> enrollments = getAllEnrollments();
    	for (Enrollment enrollment : enrollments) {
    		LOGGER.info("Sending alert  for Enrollment : "+enrollment.getCurrentMilestoneName());
    		enrollmentAlertServiceToExportOSGi.scheduleAlertsForCurrentMilestone(enrollment);
			LOGGER.info("Sent alert  for Enrollment : "+enrollment.getCurrentMilestoneName());
		}
    }
    
    private List<Enrollment> getAllEnrollments() {
    	
         List<Enrollment> enrollments = new ArrayList<Enrollment>();
         for (Integer primaryId : AllMissingTasks) {
        	 LOGGER.info("Fetching Enrollment for unique key : "+primaryId);
        	 Enrollment enrollment = dbRepository.getObjectByPrimaryKey(Enrollment.class, primaryId);
        	 LOGGER.info("Fetched Enrollment with current milestone : "+enrollment.getCurrentMilestoneName());
        	enrollments.add(enrollment);
		}
    	return enrollments;    
    }
    
    private List<Map<String, Object>> getTasksTobeClosed (){
    	JdbcTemplate jdbcTemplate = new JdbcTemplate(careDataSource);	
   		return jdbcTemplate.queryForList(""); 
    }
    
    public void closeAllCases() throws IOException {
    	
    	List<String> careCaseTasks = readAllCareCaseId();
    	  int counter = 1;
    	  for (String caseId : careCaseTasks) {
    		  LOGGER.info(counter+". Sending close case for Care Case Task with id"+caseId);
    			  postCloseToCommCare(caseId);
    			  counter++;
    		  }
    	   LOGGER.info("Total case closed :"+counter);
    }
    
    protected void postCloseToCommCare(String careCaseTaskId) {
    	
        String commcareUrl = COMMCARE_HQ_URL;
        String commcareUsername = COMMCARE_USERNAME;
        String commcarePassword = COMMCARE_PASSWORD;

        CareCaseTask careCaseTask = dbRepository.get(CareCaseTask.class, "caseId", careCaseTaskId);

        LOGGER.info(String
                .format("Notifying commcare to close task with -- TaskId: %s ",
                        careCaseTask.getCaseId()));
       commcareCaseGateway.closeCase(commcareUrl, CommcareTask.toCaseTask(careCaseTask), commcareUsername,commcarePassword, null);
       
    }
  
    
    private List<String> readAllCareCaseId() throws IOException {
    	List<String> careCaseTasks = new ArrayList<String>();
    	LOGGER.info("Loading Resource");
    	String fileLocation = "/home/naveen/skype_downloads/tobeclosed.txt";
    	@SuppressWarnings("resource")
		BufferedReader bufferedReader = new BufferedReader(new FileReader(fileLocation));
    	      String CareCaseTaskId;
    	      int counter =1;
    	      while ((CareCaseTaskId = bufferedReader.readLine()) != null) {
			     LOGGER.info(counter+". Fetched Care Case Task Id : "+CareCaseTaskId);
				careCaseTasks.add(CareCaseTaskId);
				counter++;
			}
    	return careCaseTasks;
    }


}
